# Copyright 2020 The Knative Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: triggers.eventing.knative.dev
  labels:
    eventing.knative.dev/release: devel
    knative.dev/crd-install: "true"
spec:
  group: eventing.knative.dev
  versions:
  - &version
    name: v1beta1
    served: true
    storage: true
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Ready
      type: string
      jsonPath: ".status.conditions[?(@.type==\"Ready\")].status"
    - name: Reason
      type: string
      jsonPath: ".status.conditions[?(@.type==\"Ready\")].reason"
    - name: Broker
      type: string
      jsonPath: .spec.broker
    - name: Subscriber_URI
      type: string
      jsonPath: .status.subscriberUri
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    schema:
      openAPIV3Schema:
        type: object
        description: "This is a trigger description."
        properties:
          spec:
            required:
              - subscriber
            type: object
            description: "The specification for the trigger"
            properties:
              broker:
                type: string
                description: "Broker that this trigger receives events from. If not specified, will default to 'default'."
              filter:
                description: "Optional filter to apply against all events from the Broker. Only events that pass this filter will be sent to the Subscriber. If not specified, will default to allowing all events."
                type: object
                properties:
                  attributes:
                    type: object
                    description: "Map of CloudEvents attributes used for filtering events. If not specified, will default to all events. Each key in the map is compared with the equivalent key in the event context. An event passes the filter if all values are equal to the specified values."
                    additionalProperties:
                      type: string
              subscriber:
                type: object
                description: "Subscriber is the addressable that receives events from the Broker that pass the filter."
                properties:
                  ref:
                    type: object
                    description: "a reference to a Kubernetes object from which to retrieve the target URI."
                    required:
                    - apiVersion
                    - kind
                    - name
                    properties:
                      apiVersion:
                        type: string
                        minLength: 1
                      kind:
                        type: string
                        minLength: 1
                      namespace:
                        type: string
                        minLength: 1
                      name:
                        type: string
                        minLength: 1
                  uri:
                    type: string
                    description: "The full target URI or, if ref is provided, a relative URI reference that will be combined with ref to produce a target URI."
          status:
            type: object
            description: "Status of the trigger"
            properties:
              subscriberUri:
                type: string
                description: "SubscriberURI is the resolved URI of the receiver for this Trigger."
              observedGeneration:
                type: integer
                description: "ObservedGeneration is the 'Generation' of the Trigger that was last processed by the controller."
  - << : *version
    name: v1
    served: true
    storage: false
    schema:
      openAPIV3Schema:
        type: object
        description: "This is a trigger description."
        properties:
          spec:
            required:
              - broker
              - subscriber
            type: object
            description: "The specification for the trigger"
            properties:
              broker:
                type: string
                description: "Broker that this trigger receives events from."
              filter:
                description: "Optional filter to apply against all events from the Broker. Only events that pass this filter will be sent to the Subscriber. If not specified, will default to allowing all events."
                type: object
                properties:
                  attributes:
                    type: object
                    description: "Map of CloudEvents attributes used for filtering events. If not specified, will default to all events. Each key in the map is compared with the equivalent key in the event context. An event passes the filter if all values are equal to the specified values."
                    additionalProperties:
                      type: string
              subscriber:
                type: object
                description: "Subscriber is the addressable that receives events from the Broker that pass the filter. You can use one or both of ref/uri to specify the "
                properties:
                  ref:
                    type: object
                    description: "Reference to a Kubernetes object (addressable) from which to retrieve the target URI."
                    required:
                    - apiVersion
                    - kind
                    - name
                    properties:
                      apiVersion:
                        type: string
                        minLength: 1
                      kind:
                        type: string
                        minLength: 1
                      namespace:
                        type: string
                        minLength: 1
                      name:
                        type: string
                        minLength: 1
                  uri:
                    type: string
                    description: "The full target URI or, if ref is provided, a relative URI reference that will be combined with ref to produce a target URI."
          status:
            type: object
            description: "status of the trigger"
            properties:
              subscriberUri:
                type: string
                description: "SubscriberURI is the resolved URI of the receiver for this Trigger."
              observedGeneration:
                type: integer
                description: "ObservedGeneration is the 'Generation' of the Trigger that was last processed by the controller."
  names:
    kind: Trigger
    plural: triggers
    singular: trigger
    categories:
    - all
    - knative
    - eventing
  scope: Namespaced
  conversion:
    strategy: Webhook
    webhook:
      conversionReviewVersions: ["v1", "v1beta1"]
      clientConfig:
        service:
          name: eventing-webhook
          namespace: knative-eventing
